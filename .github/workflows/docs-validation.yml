name: Documentation Validation

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'docs/**'
      - 'README.md'
      - '.github/workflows/docs-validation.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'docs/**'
      - 'README.md'
      - '.github/workflows/docs-validation.yml'

jobs:
  # æ–‡æ¡£ç»“æž„éªŒè¯
  docs-structure:
    name: Documentation Structure Validation
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Validate documentation structure
      run: |
        echo "ðŸ” Validating documentation structure..."
        
        # æ£€æŸ¥å¿…éœ€çš„æ–‡æ¡£ç›®å½•
        required_dirs=(
          "docs"
          "docs/api"
          "docs/guides"
          "docs/development"
          "docs/reports"
        )
        
        missing_dirs=()
        for dir in "${required_dirs[@]}"; do
          if [ ! -d "$dir" ]; then
            missing_dirs+=("$dir")
          fi
        done
        
        if [ ${#missing_dirs[@]} -ne 0 ]; then
          echo "âŒ Missing required directories:"
          printf '%s\n' "${missing_dirs[@]}"
          exit 1
        fi
        
        # æ£€æŸ¥å¿…éœ€çš„æ–‡æ¡£æ–‡ä»¶
        required_docs=(
          "docs/index.md"
          "docs/api/reference.md"
          "docs/api/configuration.md"
          "docs/guides/examples.md"
          "docs/guides/testing.md"
          "docs/guides/monitoring.md"
          "docs/guides/troubleshooting.md"
          "docs/development/architecture.md"
          "docs/development/contributing.md"
          "docs/development/quality.md"
          "docs/development/changelog.md"
        )
        
        missing_docs=()
        for doc in "${required_docs[@]}"; do
          if [ ! -f "$doc" ]; then
            missing_docs+=("$doc")
          fi
        done
        
        if [ ${#missing_docs[@]} -ne 0 ]; then
          echo "âŒ Missing required documentation files:"
          printf '%s\n' "${missing_docs[@]}"
          exit 1
        fi
        
        echo "âœ… All required documentation files and directories are present"

    - name: Check documentation links
      run: |
        echo "ðŸ”— Checking documentation links..."
        
        # æ£€æŸ¥ README.md ä¸­çš„é“¾æŽ¥
        echo "Checking README.md links..."
        
        # æå–æ‰€æœ‰ markdown é“¾æŽ¥
        grep -oE '\[.*\]\([^)]+\)' README.md | while read -r link; do
          # æå–é“¾æŽ¥è·¯å¾„
          path=$(echo "$link" | sed -n 's/.*(\([^)]*\)).*/\1/p')
          
          # è·³è¿‡å¤–éƒ¨é“¾æŽ¥å’Œé”šç‚¹é“¾æŽ¥
          if [[ "$path" =~ ^https?:// ]] || [[ "$path" =~ ^# ]]; then
            continue
          fi
          
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ ! -f "$path" ] && [ ! -d "$path" ]; then
            echo "âŒ Broken link in README.md: $link -> $path"
            exit 1
          fi
        done
        
        echo "âœ… All documentation links are valid"

    - name: Validate markdown syntax
      uses: DavidAnson/markdownlint-cli2-action@v13
      with:
        globs: |
          README.md
          docs/**/*.md

  # æ–‡æ¡£å†…å®¹è´¨é‡æ£€æŸ¥
  docs-quality:
    name: Documentation Quality Check
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check documentation completeness
      run: |
        echo "ðŸ“‹ Checking documentation completeness..."
        
        # æ£€æŸ¥ API æ–‡æ¡£æ˜¯å¦åŒ…å«æ‰€æœ‰ä¸»è¦åŠŸèƒ½
        api_keywords=(
          "NewMySQLBatchSQL"
          "NewPostgreSQLBatchSQL"
          "NewSQLiteBatchSQL"
          "NewRedisBatchSQL"
          "WithMetricsReporter"
          "Schema"
          "Request"
          "ConflictStrategy"
        )
        
        for keyword in "${api_keywords[@]}"; do
          if ! grep -r "$keyword" docs/api/ > /dev/null; then
            echo "âš ï¸ API keyword '$keyword' not found in API documentation"
          fi
        done
        
        # æ£€æŸ¥ç¤ºä¾‹æ–‡æ¡£æ˜¯å¦åŒ…å«æ‰€æœ‰æ•°æ®åº“ç±»åž‹
        db_types=("MySQL" "PostgreSQL" "SQLite" "Redis")
        for db in "${db_types[@]}"; do
          if ! grep -i "$db" docs/guides/examples.md > /dev/null; then
            echo "âš ï¸ Database type '$db' not found in examples documentation"
          fi
        done
        
        echo "âœ… Documentation completeness check completed"

    - name: Check for outdated information
      run: |
        echo "ðŸ• Checking for potentially outdated information..."
        
        # æ£€æŸ¥æ˜¯å¦æœ‰ç¡¬ç¼–ç çš„ç‰ˆæœ¬å·éœ€è¦æ›´æ–°
        if grep -r "v1\.[0-9]\.[0-9]" docs/ README.md | grep -v "example\|ç¤ºä¾‹"; then
          echo "âš ï¸ Found hardcoded version numbers that may need updating"
        fi
        
        # æ£€æŸ¥æ˜¯å¦æœ‰è¿‡æ—¶çš„ Go ç‰ˆæœ¬å¼•ç”¨
        if grep -r "go 1\.[0-9][0-9]" docs/ README.md | grep -v "1.23"; then
          echo "âš ï¸ Found references to old Go versions"
        fi
        
        echo "âœ… Outdated information check completed"

  # ç›‘æŽ§ç³»ç»Ÿæ–‡æ¡£éªŒè¯
  monitoring-docs:
    name: Monitoring Documentation Validation
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Validate monitoring configuration files
      run: |
        echo "ðŸ“Š Validating monitoring configuration files..."
        
        # æ£€æŸ¥ Grafana é…ç½®æ–‡ä»¶
        grafana_configs=(
          "test/integration/grafana/provisioning/dashboards/batchsql-performance.json"
          "test/integration/grafana/provisioning/datasources/prometheus.yml"
        )
        
        for config in "${grafana_configs[@]}"; do
          if [ ! -f "$config" ]; then
            echo "âŒ Missing Grafana configuration: $config"
            exit 1
          fi
        done
        
        # æ£€æŸ¥ Prometheus é…ç½®
        if [ ! -f "test/integration/grafana/prometheus.yml" ]; then
          echo "âŒ Missing Prometheus configuration"
          exit 1
        fi
        
        # æ£€æŸ¥ç›‘æŽ§è„šæœ¬
        if [ ! -f "scripts/start-monitoring.sh" ]; then
          echo "âŒ Missing monitoring startup script"
          exit 1
        fi
        
        echo "âœ… All monitoring configuration files are present"

    - name: Validate monitoring documentation
      run: |
        echo "ðŸ“– Validating monitoring documentation..."
        
        # æ£€æŸ¥ç›‘æŽ§æŒ‡å—æ˜¯å¦åŒ…å«å¿…è¦ä¿¡æ¯
        monitoring_keywords=(
          "Prometheus"
          "Grafana"
          "localhost:3000"
          "localhost:9090"
          "æ•°æ®å®Œæ•´æ€§"
          "RPS"
          "å“åº”æ—¶é—´"
        )
        
        for keyword in "${monitoring_keywords[@]}"; do
          if ! grep -i "$keyword" docs/guides/monitoring.md > /dev/null; then
            echo "âš ï¸ Monitoring keyword '$keyword' not found in monitoring guide"
          fi
        done
        
        echo "âœ… Monitoring documentation validation completed"

  # ç”Ÿæˆæ–‡æ¡£æŠ¥å‘Š
  docs-report:
    name: Generate Documentation Report
    runs-on: ubuntu-latest
    needs: [docs-structure, docs-quality, monitoring-docs]
    if: always()
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Generate documentation report
      run: |
        echo "# Documentation Validation Report" > docs_report.md
        echo "" >> docs_report.md
        echo "Generated on: $(date -u)" >> docs_report.md
        echo "" >> docs_report.md
        
        echo "## Validation Results" >> docs_report.md
        echo "" >> docs_report.md
        
        if [ "${{ needs.docs-structure.result }}" == "success" ]; then
          echo "âœ… **Documentation Structure**: All required files and directories are present" >> docs_report.md
        else
          echo "âŒ **Documentation Structure**: Missing required files or directories" >> docs_report.md
        fi
        
        if [ "${{ needs.docs-quality.result }}" == "success" ]; then
          echo "âœ… **Documentation Quality**: Content completeness check passed" >> docs_report.md
        else
          echo "âŒ **Documentation Quality**: Content quality issues found" >> docs_report.md
        fi
        
        if [ "${{ needs.monitoring-docs.result }}" == "success" ]; then
          echo "âœ… **Monitoring Documentation**: All monitoring configs and docs are valid" >> docs_report.md
        else
          echo "âŒ **Monitoring Documentation**: Monitoring documentation issues found" >> docs_report.md
        fi
        
        echo "" >> docs_report.md
        echo "## Documentation Statistics" >> docs_report.md
        echo "" >> docs_report.md
        echo "- **Total Markdown Files**: $(find . -name '*.md' | wc -l)" >> docs_report.md
        echo "- **Documentation Files**: $(find docs/ -name '*.md' | wc -l)" >> docs_report.md
        echo "- **API Documentation Files**: $(find docs/api/ -name '*.md' | wc -l)" >> docs_report.md
        echo "- **Guide Files**: $(find docs/guides/ -name '*.md' | wc -l)" >> docs_report.md
        echo "- **Development Documentation**: $(find docs/development/ -name '*.md' | wc -l)" >> docs_report.md
        echo "" >> docs_report.md
        echo "## Recommendations" >> docs_report.md
        echo "- Keep documentation up to date with code changes" >> docs_report.md
        echo "- Regularly review and update version references" >> docs_report.md
        echo "- Ensure all new features have corresponding documentation" >> docs_report.md

    - name: Upload documentation report
      uses: actions/upload-artifact@v3
      with:
        name: documentation-validation-report
        path: docs_report.md
        retention-days: 30

    - name: Comment PR with documentation status
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const report = fs.readFileSync('docs_report.md', 'utf8');
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## ðŸ“š Documentation Validation Results\n\n${report}`
          });