name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Set up Go
      uses: actions/setup-go@v6
      with:
        go-version: '1.21'
        
    - name: Run tests
      run: go test -v ./...
      
    - name: Generate changelog
      id: changelog
      run: |
        # 生成变更日志
        echo "## Changes" > RELEASE_CHANGELOG.md
        git log --pretty=format:"- %s" $(git describe --tags --abbrev=0 HEAD^)..HEAD >> RELEASE_CHANGELOG.md
        
    - name: Create Release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: Release ${{ github.ref }}
        body_path: RELEASE_CHANGELOG.md
        draft: false
        prerelease: false

  # Go模块发布验证
  go-mod-verify:
    name: Go Module Verification
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Go
      uses: actions/setup-go@v6
      with:
        go-version: '1.21'
        
    - name: Verify module
      run: |
        go mod verify
        go mod tidy
        git diff --exit-code go.mod go.sum
        
    - name: Test module import
      run: |
        # 测试模块可以被正确导入
        cd /tmp
        go mod init test
        go get github.com/rushairer/batchsql@${{ github.ref_name }}
        echo 'package main; import _ "github.com/rushairer/batchsql"; func main() {}' > main.go
        go build main.go